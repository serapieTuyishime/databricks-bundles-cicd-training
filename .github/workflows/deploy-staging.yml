name: deploy to staging

on:
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: setup

    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy bundle to staging
        run: |
          databricks bundle deploy --target staging

      - name: Log deployed resources
        run: |
          databricks bundle summary -t staging

      - name: Run Databricks job (staging parameters)
        id: run_job
        run: |
          JOB_ID=$(databricks bundle summary -t staging --output json | jq -r '.resources.jobs.example_job.id')
          echo "Job ID: $JOB_ID"

          RUN_ID=$(databricks jobs run-now "$JOB_ID" --output json | jq -r '.run_id')
          echo "Run ID: $RUN_ID"

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Verify output table
        run: |
          TABLE_EXISTS=$(databricks tables get workspace.default.example_output 2>/dev/null && echo "true" || echo "false")

          if [ "$TABLE_EXISTS" != "true" ]; then
            echo "Verification failed: output table not found"
            exit 1
          fi

          echo "Verification succeeded: staging output table exists"
