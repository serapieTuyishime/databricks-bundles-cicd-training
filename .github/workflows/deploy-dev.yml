name: deploy to dev on merge to main
on:
#  pull_request:
#    types: [closed]
#    branches:
#      - main
  push:
    branches:
      - main
jobs:
  deploy:
#    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    environment: setup

    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - name: checkout code
        uses: actions/checkout@v3
      - name: Install databricks cli
        uses: databricks/setup-cli@main
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
      - name: Deploy bundle to Dev
        run: |
          databricks bundle deploy --target dev
      - name: Log deployed resources
        run: |
          echo "=== Deployed Resources ==="
          databricks bundle summary -t dev
      - name: Run Databricks job
        id: run_job
        run: |
          JOB_ID=$(databricks bundle summary -t dev --output json | jq -r '.resources.jobs.example_job.id')
          echo "Job ID: $JOB_ID"
          
          RUN_ID=$(databricks jobs run-now --job-id "$JOB_ID" --output json | jq -r '.run_id')
          echo "Run ID: $RUN_ID"
          
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          
          # 4️⃣ Wait for completion
          - name: Wait for job completion
            run: |
              databricks jobs runs wait ${{ steps.run_job.outputs.run_id }}
          
          # 5️⃣ Verify output (Delta table row count)
          - name: Verify job output
            run: |
              ROW_COUNT=$(databricks sql query \
                --warehouse-id ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }} \
                --query "SELECT COUNT(*) AS cnt FROM default.example_output" \
                --output json | jq -r '.result.data_array[0][0]')
              
              echo "Row count: $ROW_COUNT"
              
              if [ "$ROW_COUNT" -le 0 ]; then
                echo "Verification failed: no data produced"
                exit 1
              fi
              
              echo "Verification succeeded"